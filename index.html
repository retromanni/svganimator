<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PNG to SVG: NFT Animation (50 Repeats)</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI',sans-serif; background:#1a1a1a; color:#eee; padding:20px; }
    .container { max-width:900px; margin:0 auto; }
    h1 { text-align:center; color:#4CAF50; margin-bottom:10px; }
    .note { text-align:center; color:#aaa; font-size:14px; margin-bottom:20px; }

    .controls { background:#2a2a2a; padding:20px; border-radius:12px;
                margin-bottom:20px; box-shadow:0 4px 12px rgba(0,0,0,.3); }
    .control-group { margin-bottom:16px; }
    label { display:block; margin-bottom:6px; font-size:14px; color:#aaa; }

    .drop-area {
      width:100%; padding:40px; background:#3a3a3a; border:2px dashed #555;
      border-radius:8px; text-align:center; cursor:pointer; transition:all .2s;
      color:#ccc; font-size:16px;
    }
    .drop-area.dragover {
      background:#4a4a4a; border-color:#4CAF50; color:#4CAF50;
      box-shadow:0 0 12px rgba(76,175,80,.3);
    }
    .drop-area input[type="file"] { display:none; }

    input[type="number"],input[type="range"] { width:100%; padding:8px; background:#3a3a3a;
                         border:1px solid #555; border-radius:6px; color:#fff; }
    input[type="range"] { height:36px; padding:0; }
    .range-value { margin-left:10px; color:#4CAF50; font-weight:bold; }
    .buttons { display:flex; gap:12px; margin-top:20px; }
    button { flex:1; padding:14px; background:#4CAF50; border:none; border-radius:6px;
             color:white; font-size:16px; font-weight:600; cursor:pointer; }
    button:hover:not(:disabled) { background:#45a049; }
    button:disabled { background:#666; cursor:not-allowed; opacity:.6; }

    .preview { background:#000; border-radius:12px; min-height:400px; padding:20px;
               display:flex; justify-content:center; align-items:center; overflow:hidden;
               box-shadow:0 4px 12px rgba(0,0,0,.3); margin-bottom:20px; }
    .preview object { width:100%; height:100%; border:1px solid #333; border-radius:6px; }

    .status { text-align:center; padding:12px; background:#2a2a2a; border-radius:6px;
              font-size:14px; }
    .info { color:#4CAF50; font-weight:bold; }
    .error { color:#f44336; }
    .warning { color:#ff9800; }

    .file-info { margin-top:8px; font-size:12px; color:#888; }
    .progress { margin-top:8px; font-size:12px; color:#4CAF50; }
    .sub-controls { margin-left:20px; padding:12px; background:#333; border-radius:8px; margin-top:8px; }
    .intro-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .remove-intro { color:#f44336; cursor:pointer; font-weight:bold; }
  </style>
</head>
<body>
<div class="container">
  <h1>PNG to Animated SVG (NFT)</h1>
  <p class="note">
    Drag & drop PNGs → Add intros (up to 50 repeats) → Loop forever
  </p>

  <div class="controls">
    <!-- Upload -->
    <div class="control-group">
      <label>Upload PNG Frames (in order):</label>
      <div class="drop-area" id="dropArea">
        <p>Drop PNG files here or click to browse</p>
        <input type="file" id="fileInput" accept="image/png" multiple>
      </div>
      <div style="font-size:12px;color:#888;margin-top:4px;">
        Name like: frame1.png, frame2.png, frame10.png
      </div>
      <div class="file-info" id="fileInfo"></div>
    </div>

    <!-- Frame Rate -->
    <div class="control-group">
      <label>Frame Rate: <span class="range-value" id="fpsValue">12</span> FPS</label>
      <input type="range" id="fps" min="1" max="60" value="12">
    </div>

    <!-- Intros Container -->
    <div id="introsContainer"></div>

    <!-- Add Intro Button -->
    <div class="control-group">
      <button id="addIntroBtn">+ Add Intro</button>
    </div>

    <!-- Loop -->
    <div class="control-group">
      <label>Loop Range (repeats forever):</label>
      <div style="display:flex;gap:10px;">
        <input type="number" id="loopStart" min="1" value="1" style="flex:1;">
        <span style="align-self:center;">to</span>
        <input type="number" id="loopEnd" min="1" value="10" style="flex:1;">
      </div>
    </div>

    <!-- Buttons -->
    <div class="buttons">
      <button id="generateBtn" disabled>Generate SVG</button>
      <button id="downloadBtn" disabled>Download SVG</button>
    </div>
  </div>

  <div class="preview" id="preview">
    <p style="color:#666;">Preview appears after Generate</p>
  </div>

  <div class="status" id="statusText">Drag & drop PNGs or click to upload</div>
</div>

<script>
  const $ = id => document.getElementById(id);
  const dropArea = $('dropArea');
  const fileInput = $('fileInput');
  const generateBtn = $('generateBtn');
  const downloadBtn = $('downloadBtn');
  const preview = $('preview');
  const statusText = $('statusText');
  const fpsInput = $('fps');
  const fpsValue = $('fpsValue');
  const loopStart = $('loopStart'), loopEnd = $('loopEnd');
  const fileInfo = $('fileInfo');
  const introsContainer = $('introsContainer');
  const addIntroBtn = $('addIntroBtn');

  let frames = [], svgContent = '';
  let introCounter = 0;

  // === DRAG & DROP ===
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, preventDefaults));
  function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
  ['dragenter', 'dragover'].forEach(e => dropArea.addEventListener(e, () => dropArea.classList.add('dragover')));
  ['dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, () => dropArea.classList.remove('dragover')));
  dropArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
  dropArea.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => handleFiles(fileInput.files));

  function handleFiles(files) {
    const pngs = Array.from(files).filter(f => f.type === 'image/png');
    if (!pngs.length) { setStatus('No PNGs found.', 'error'); return; }
    fileInput.files = files;
    loadFrames(pngs);
  }

  // === FRAME LOADING ===
  async function loadFrames(files) {
    files.sort((a,b) => (a.name.match(/(\d+)/)?.[0]||0) - (b.name.match(/(\d+)/)?.[0]||0));
    frames = []; generateBtn.disabled = true; downloadBtn.disabled = true;
    setStatus('Loading frames...', 'info');

    let w = null, h = null, totalSize = 0;
    for (let i = 0; i < files.length; i++) {
      const file = files[i]; totalSize += file.size;
      fileInfo.innerHTML = `<span class="progress">Loading ${i+1}/${files.length}...</span>`;
      const dataURL = await new Promise(r => { const fr = new FileReader(); fr.onload = () => r(fr.result); fr.readAsDataURL(file); });
      const img = new Image();
      const size = await new Promise((res,rej) => { img.onload = () => res({w:img.width,h:img.height}); img.onerror = rej; img.src = dataURL; });
      if (!w) { w = size.w; h = size.h; } 
      else if (size.w !== w || size.h !== h) { setStatus(`Size mismatch: ${file.name}`, 'error'); fileInfo.innerHTML=''; return; }
      frames.push({data: dataURL, w, h});
    }

    const totalMB = (totalSize/(1024*1024)).toFixed(2);
    fileInfo.innerHTML = `Loaded ${frames.length} frames (${w}x${h}px, ~${totalMB} MB)`;
    if (totalSize > 10*1024*1024) fileInfo.innerHTML += ' <span class="warning">Large file size</span>';

    [loopStart, loopEnd].forEach(i => i.max = frames.length);
    updateAllIntroMax();
    setStatus(`Loaded ${frames.length} frames. Add intros.`, 'info');
    validateRanges();
  }

  // === ADD INTRO (NOW UP TO 50 REPEATS) ===
  addIntroBtn.addEventListener('click', addIntroPanel);

  function addIntroPanel() {
    introCounter++;
    const id = `intro${introCounter}`;
    const panel = document.createElement('div');
    panel.className = 'control-group';
    panel.innerHTML = `
      <div class="intro-header">
        <input type="checkbox" id="${id}Enable" checked>
        <label for="${id}Enable">Intro ${introCounter}</label>
        <span class="remove-intro" data-id="${id}">Remove</span>
      </div>
      <div class="sub-controls" id="${id}Controls">
        <label>Frame Range:</label>
        <div style="display:flex;gap:10px;">
          <input type="number" id="${id}Start" min="1" value="1" style="flex:1;">
          <span style="align-self:center;">to</span>
          <input type="number" id="${id}End" min="1" value="5" style="flex:1;">
        </div>
        <label style="margin-top:8px;">Repeat <span id="${id}RepeatValue">1</span> time(s):</label>
        <input type="range" id="${id}Repeat" min="1" max="50" value="1">
      </div>
    `;
    introsContainer.appendChild(panel);

    $(`${id}Enable`).addEventListener('change', () => {
      $(`${id}Controls`).style.display = $(`${id}Enable`).checked ? 'block' : 'none';
      validateRanges();
    });
    $(`${id}Repeat`).addEventListener('input', () => $(`${id}RepeatValue`).textContent = $(`${id}Repeat`).value);
    [$(`${id}Start`), $(`${id}End`)].forEach(i => i.addEventListener('input', validateRanges));
    panel.querySelector('.remove-intro').addEventListener('click', () => {
      panel.remove();
      validateRanges();
    });

    updateAllIntroMax();
    validateRanges();
  }

  function updateAllIntroMax() {
    const max = frames.length;
    document.querySelectorAll('input[id$="Start"], input[id$="End"]').forEach(i => i.max = max);
  }

  // === VALIDATION ===
  function validateRanges() {
    try {
      if (!frames.length) return;
      const total = frames.length;
      const lS = parseInt(loopStart.value), lE = parseInt(loopEnd.value);
      if (lS < 1 || lE > total || lS > lE) throw new Error("Invalid loop range");

      let lastEnd = 0;
      const intros = Array.from(introsContainer.children);
      for (const panel of intros) {
        const enable = panel.querySelector('input[type=checkbox]').checked;
        if (!enable) continue;
        const s = parseInt(panel.querySelector('input[id$="Start"]').value);
        const e = parseInt(panel.querySelector('input[id$="End"]').value);
        if (s < 1 || e > total || s > e) throw new Error(`Invalid range in ${panel.querySelector('label').textContent}`);
        if (s <= lastEnd) throw new Error(`Overlapping intros: ${panel.querySelector('label').textContent}`);
        lastEnd = e;
      }
      if (lS <= lastEnd) throw new Error("Loop must start after last intro");
      generateBtn.disabled = false;
      setStatus('Ready to generate', 'info');
    } catch (e) {
      generateBtn.disabled = true;
      setStatus(e.message, 'error');
    }
  }

  [loopStart, loopEnd].forEach(i => i.addEventListener('input', validateRanges));
  fpsInput.addEventListener('input', () => fpsValue.textContent = fpsInput.value);

  function setStatus(msg, type = 'info') {
    statusText.textContent = msg;
    statusText.className = 'status ' + type;
  }

  // === GENERATE SVG ===
  generateBtn.addEventListener('click', async () => {
    generateBtn.disabled = true; downloadBtn.disabled = true;
    setStatus('Building sprite sheet...', 'info');

    const fps = parseInt(fpsInput.value);
    const frameTime = 1 / fps;
    const w = frames[0].w, h = frames[0].h;
    const totalW = w * frames.length;

    const canvas = document.createElement('canvas');
    canvas.width = totalW; canvas.height = h;
    const ctx = canvas.getContext('2d', { alpha: true });
    ctx.imageSmoothingEnabled = false;
    const img = new Image();

    for (let i = 0; i < frames.length; i++) {
      await new Promise(res => { img.onload = () => { ctx.drawImage(img, i * w, 0); res(); }; img.src = frames[i].data; });
      if (i % 5 === 0) setStatus(`Building sprite sheet... ${Math.round((i/frames.length)*100)}%`, 'info');
    }
    setStatus('Encoding sprite sheet...', 'info');
    const spriteData = canvas.toDataURL('image/png');

    const anims = [];
    let begin = '0s';

    const intros = Array.from(introsContainer.children);
    intros.forEach((panel, idx) => {
      const enable = panel.querySelector('input[type=checkbox]').checked;
      if (!enable) return;
      const s = parseInt(panel.querySelector('input[id$="Start"]').value) - 1;
      const e = parseInt(panel.querySelector('input[id$="End"]').value) - 1;
      const values = Array.from({length: e - s + 1}, (_, i) => -(s + i) * w);
      const dur = (e - s + 1) * frameTime;
      const repeat = parseInt(panel.querySelector('input[id$="Repeat"]').value);
      const id = `intro${idx}`;
      anims.push(`<animate id="${id}" attributeName="x" values="${values.join(';')}" dur="${dur}s" calcMode="discrete" repeatCount="${repeat}" begin="${begin}"/>`);
      begin = `${id}.end`;
    });

    const lS = parseInt(loopStart.value) - 1, lE = parseInt(loopEnd.value) - 1;
    const loopValues = Array.from({length: lE - lS + 1}, (_, i) => -(lS + i) * w);
    const loopDur = (lE - lS + 1) * frameTime;
    anims.push(`<animate id="loop" attributeName="x" values="${loopValues.join(';')}" dur="${loopDur}s" calcMode="discrete" repeatCount="indefinite" begin="${begin}"/>`);

    const svg = `<svg xmlns="http://www.w3.org/2000/svg"
     viewBox="0 0 ${w} ${h}"
     width="100%" height="100%"
     preserveAspectRatio="xMidYMid meet"
     style="image-rendering:pixelated;">
  <defs><clipPath id="clip"><rect width="${w}" height="${h}"/></clipPath></defs>
  <image href="${spriteData}" width="${totalW}" height="${h}" clip-path="url(#clip)" x="0" y="0" style="image-rendering:pixelated;">
    ${anims.join('\n    ')}
  </image>
</svg>`.trim();

    svgContent = svg;
    const blob = new Blob([svg], { type: 'image/svg+xml' });
    const sizeKB = (blob.size / 1024).toFixed(2);
    const url = URL.createObjectURL(blob);
    preview.innerHTML = `<object type="image/svg+xml" data="${url}" style="width:100%;height:100%;"></object>`;

    downloadBtn.disabled = false;
    setStatus(`SVG ready! (${sizeKB} KB)`, 'info');
    generateBtn.disabled = false;
  });

  downloadBtn.addEventListener('click', () => {
    const blob = new Blob([svgContent], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'nft-animation.svg';
    a.click(); URL.revokeObjectURL(url);
    setStatus('Downloaded!', 'info');
  });
</script>
</body>
</html>
