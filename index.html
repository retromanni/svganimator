<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SVG Animator</title>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
<style>
*{box-sizing:border-box}
body{font-family:Inter,Segoe UI,system-ui,Arial;background:#0f0f10;color:#eee;margin:0;padding:20px}
.wrap{max-width:980px;margin:0 auto}
h1{color:#4CAF50;text-align:center;margin:6px 0 8px}
.note{color:#9aa;font-size:14px;text-align:center;margin-bottom:16px}
.card{background:#171717;padding:16px;border-radius:12px;border:1px solid #222;box-shadow:0 6px 18px rgba(0,0,0,.6)}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
label{display:block;color:#bfbfbf;font-size:13px;margin-bottom:6px}
.drop{border:2px dashed #2a2a2a;background:#131313;padding:28px;border-radius:10px;text-align:center;cursor:pointer;color:#bfbfbf}
.drop.dragover{background:#172917;border-color:#3e8c3e;color:#7fe17f}
input[type=file]{display:none}
.small{font-size:13px;color:#98a}
input[type="range"]{width:100%}
input[type="number"], select{width:100%;padding:8px;border-radius:8px;border:1px solid #2a2a2a;background:#111;color:#fff}
.toolsRow{display:flex;gap:12px;margin-top:14px}
.toolBtn{flex:1;padding:12px;border-radius:8px;background:#131313;border:1px solid #242424;color:#ddd;cursor:pointer;text-align:center}
.toolBtn.active{background:#183018;border-color:#2f6b2f;color:#dfffe1}
.toolArea{margin-top:12px}
.intro-panel{background:#141414;border-radius:8px;padding:10px;border:1px solid #232323;margin-top:10px}
.intro-row{display:flex;gap:8px;align-items:center}
.repeat-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.fps-row{margin-top:8px;display:none;align-items:center;gap:8px}
.fps-row label{font-size:13px;color:#bfbfbf;flex:0 0 auto}
.remove{color:#ff8080;cursor:pointer;padding:6px;border-radius:6px;background:transparent}
.btns{display:flex;gap:10px;margin-top:14px}
button.primary{flex:1;padding:12px;border-radius:8px;border:0;background:#4CAF50;color:#061;cursor:pointer;font-weight:700}
button.ghost{flex:1;padding:12px;border-radius:8px;border:1px solid #333;background:transparent;color:#ddd;cursor:pointer}
button:disabled{opacity:.45;cursor:not-allowed}
.preview{background:#000;border-radius:10px;min-height:380px;margin-top:16px;padding:12px;display:flex;align-items:center;justify-content:center;border:1px solid #222;overflow:hidden}
.status{margin-top:10px;padding:10px;border-radius:8px;background:#0f0f0f;color:#bdbdbd;text-align:center}
footer{margin-top:24px;font-size:14px;color:#888;text-align:center}
footer a{color:#4CAF50;text-decoration:none}
@media (max-width:720px){
  .row{flex-direction:column}
  .toolsRow{flex-direction:column}
  .btns{flex-direction:column}
}
</style>
</head>
<body>
<div class="wrap">
  <h1>SVG Animator</h1>
  <p class="note">Upload PNG frames, set FPS, choose a tool. Tool 1 = intros then required final loop. Tool 2 = playlist (no final loop).</p>

  <div class="card">
    <!-- Upload + Global FPS -->
    <div class="row" style="gap:16px">
      <div class="col">
        <label>Upload PNG frames (numerical filenames recommended)</label>
        <div id="drop" class="drop">Drop PNG files here or click to browse</div>
        <input id="fileInput" type="file" accept="image/png" multiple />
        <div id="fileInfo" class="small" style="margin-top:8px">No frames loaded</div>
      </div>
      <div style="width:220px">
        <label>Global FPS: <span id="fpsLabel">12</span></label>
        <input id="fps" type="range" min="1" max="60" value="12" />
        <div class="small" style="margin-top:8px">Used when a segment has no custom FPS.</div>
      </div>
    </div>

    <!-- Tool selector -->
    <div style="margin-top:14px">
      <label>Select tool</label>
      <div class="toolsRow">
        <div id="toolBtn1" class="toolBtn active">Tool 1 — Intros to Final Loop</div>
        <div id="toolBtn2" class="toolBtn">Tool 2 — Playlist</div>
      </div>
    </div>

    <!-- Dynamic tool area -->
    <div id="toolArea" class="toolArea">
      <!-- Tool 1 UI -->
      <div id="tool1UI">
        <label>Intros (optional) — ascending, non-overlapping ranges</label>
        <div id="intros1Container"></div>
        <div style="margin-top:8px"><button id="addIntro1" class="ghost">+ Add Intro</button></div>

        <div style="margin-top:12px">
          <label>Final loop (required) — frames to loop forever after intros</label>
          <div class="intro-row" style="margin-top:6px">
            <input id="t1LoopStart" type="number" min="1" value="1" />
            <div style="align-self:center;color:#9a9a9a">to</div>
            <input id="t1LoopEnd" type="number" min="1" value="1" />
          </div>
          <div style="margin-top:8px;display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="loopUseCustomFps">
            <label for="loopUseCustomFps" style="font-size:13px;color:#bfbfbf;cursor:pointer">Custom FPS for loop</label>
          </div>
          <div id="loopFpsRow" class="fps-row">
            <label>FPS: <span id="loopFpsVal">12</span></label>
            <input id="loopCustomFps" type="range" min="1" max="60" value="12" />
          </div>
          <div class="small" style="margin-top:8px">Final loop is required for Tool 1. Generate disabled until valid.</div>
        </div>
      </div>

      <!-- Tool 2 UI -->
      <div id="tool2UI" style="display:none">
        <label>Sections (playlist) — add sections and their repeats. Sequence loops indefinitely.</label>
        <div id="intros2Container"></div>
        <div style="margin-top:8px"><button id="addIntro2" class="ghost">+ Add Section</button></div>
        <div class="small" style="margin-top:8px">Add at least one section to enable Generate.</div>
      </div>
    </div>

    <!-- Generate / Download -->
    <div class="btns" style="margin-top:14px">
      <button id="generateBtn" class="primary" disabled>Generate SVG</button>
      <button id="downloadBtn" class="ghost" disabled>Download SVG</button>
      <button id="copyBtn" class="ghost" disabled>Copy SVG</button>
    </div>
    <div id="status" class="status">Awaiting frames...</div>
  </div>

  <div id="preview" class="preview"><div style="color:#8f9">Preview appears after Generate</div></div>

  <footer>
    Open source tool created by <a href="https://x.com/retro_manni" target="_blank">Retro Manni</a>.<br>
    You can mint your SVG download fully on-chain via <a href="https://zerounbound.art" target="_blank">ZeroUnbound.Art</a> on the Tezos blockchain.
  </footer>
</div>

<script>
// ----------------------
// DOM Helpers
const $ = id => document.getElementById(id);
const drop = $('drop'), fileInput = $('fileInput'), fps = $('fps'), fpsLabel = $('fpsLabel');
const fileInfo = $('fileInfo'), statusEl = $('status');
const toolBtn1 = $('toolBtn1'), toolBtn2 = $('toolBtn2');
const tool1UI = $('tool1UI'), tool2UI = $('tool2UI');
const intros1Container = $('intros1Container'), addIntro1 = $('addIntro1');
const intros2Container = $('intros2Container'), addIntro2 = $('addIntro2');
const t1LoopStart = $('t1LoopStart'), t1LoopEnd = $('t1LoopEnd');
const loopUseCustomFps = $('loopUseCustomFps'), loopFpsRow = $('loopFpsRow');
const loopCustomFps = $('loopCustomFps'), loopFpsVal = $('loopFpsVal');
const generateBtn = $('generateBtn'), downloadBtn = $('downloadBtn'), copyBtn = $('copyBtn');
const preview = $('preview');
let frames = [], svgContent = '', activeTool=1;
let introCounter1=0, introCounter2=0;

// ----------------------
// Drag & Drop
['dragenter','dragover','dragleave','drop'].forEach(ev => drop.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation();}));
['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, ()=>drop.classList.add('dragover')));
['dragleave','drop'].forEach(ev => drop.addEventListener(ev, ()=>drop.classList.remove('dragover')));
drop.addEventListener('click', ()=>fileInput.click());
drop.addEventListener('drop', e => handleFiles(Array.from(e.dataTransfer.files || [])));
fileInput.addEventListener('change', ()=>handleFiles(Array.from(fileInput.files || [])));

async function handleFiles(list){
  const pngs = list.filter(f=>f && f.type==='image/png');
  if(!pngs.length){ setStatus('No PNG images found','error'); return; }
  await loadFrames(pngs);
}

// ----------------------
// Load frames
async function loadFrames(files){
  frames=[]; generateBtn.disabled=true; downloadBtn.disabled=true; copyBtn.disabled=true;
  files.sort((a,b)=> (Number((a.name.match(/(\d+)(?!.*\d)/)||[])[0]||0) - Number((b.name.match(/(\d+)(?!.*\d)/)||[])[0]||0)));
  let w=null,h=null;
  for(let i=0;i<files.length;i++){
    const f = files[i];
    try{
      const data = await fileToDataURL(f);
      const size = await imageSizeFromDataURL(data);
      if(w===null){ w=size.w; h=size.h; } else if(size.w!==w || size.h!==h){ setStatus(`Frame size mismatch: ${f.name}`,'error'); frames=[]; return; }
      frames.push({data,w,h});
      setStatus(`Loaded ${i+1}/${files.length} frames`,'info');
    }catch(e){console.error(e); setStatus('Error loading frames','error'); frames=[]; return;}
  }
  fileInfo.textContent = `Loaded ${frames.length} frames — ${w}×${h}px`;
  if(frames.length>200) setStatus('Warning: >200 frames may affect performance','info');
  updateAllMaxes(); validateAll();
}

function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
function imageSizeFromDataURL(data){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res({w:img.width,h:img.height}); img.onerror=rej; img.src=data; }); }

// ----------------------
// Tool switching
function setActiveTool(n){
  activeTool=n;
  toolBtn1.classList.toggle('active', n===1);
  toolBtn2.classList.toggle('active', n===2);
  tool1UI.style.display = (n===1?'block':'none');
  tool2UI.style.display = (n===2?'block':'none');
  validateAll();
}
toolBtn1.addEventListener('click', ()=>setActiveTool(1));
toolBtn2.addEventListener('click', ()=>setActiveTool(2));

// ----------------------
// Loop custom FPS
loopUseCustomFps.addEventListener('change', ()=>loopFpsRow.style.display = loopUseCustomFps.checked ? 'flex':'none');
loopCustomFps.addEventListener('input', ()=> loopFpsVal.textContent = loopCustomFps.value);

// ----------------------
// Create Panels
function createPanel(container, toolIndex){
  const id = (toolIndex===1?++introCounter1:++introCounter2);
  const panel = document.createElement('div'); panel.className='intro-panel';
  panel.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>${toolIndex===1?'Intro':'Section'} ${id}</strong>
      <span class="remove">Remove</span>
    </div>
    <div class="intro-row" style="margin-top:8px">
      <input type="number" class="start" min="1" value="1">
      <div style="align-self:center;color:#9a9a9a">to</div>
      <input type="number" class="end" min="1" value="1">
    </div>
    <div class="repeat-row">
      <label style="font-size:13px;color:#bfbfbf">Repeat <span class="repVal">1</span> time(s)</label>
      <input type="range" class="rep" min="1" max="50" value="1">
    </div>
    <div style="margin-top:8px;display:flex;align-items:center;gap:6px">
      <input type="checkbox" class="useCustomFps">
      <label style="font-size:13px;color:#bfbfbf;cursor:pointer">Custom FPS</label>
    </div>
    <div class="fps-row">
      <label>FPS: <span class="customFpsVal">12</span></label>
      <input type="range" class="customFps" min="1" max="60" value="12">
    </div>
  `;
  container.appendChild(panel);

  const start = panel.querySelector('.start'), end = panel.querySelector('.end');
  const rep = panel.querySelector('.rep'), repVal = panel.querySelector('.repVal');
  const remove = panel.querySelector('.remove');
  const useCustom = panel.querySelector('.useCustomFps');
  const fpsRow = panel.querySelector('.fps-row');
  const customFps = panel.querySelector('.customFps'), customFpsVal = panel.querySelector('.customFpsVal');

  useCustom.addEventListener('change', ()=>fpsRow.style.display=useCustom.checked?'flex':'none');
  customFps.addEventListener('input', ()=> customFpsVal.textContent=customFps.value);
  rep.addEventListener('input', ()=> repVal.textContent=rep.value);
  [start,end].forEach(i=>i.addEventListener('input',validateAll));
  remove.addEventListener('click', ()=>{ panel.remove(); updateAllMaxes(); validateAll(); });

  updateAllMaxes(); validateAll();
  return panel;
}
addIntro1.addEventListener('click', ()=>createPanel(intros1Container,1));
addIntro2.addEventListener('click', ()=>createPanel(intros2Container,2));

// ----------------------
// Max values
function updateAllMaxes(){
  const max = frames.length||1;
  document.querySelectorAll('.intro-panel .start, .intro-panel .end').forEach(i=>{ i.max=max; if(+i.value>max)i.value=max; });
  t1LoopStart.max = max; t1LoopEnd.max = max;
  if(+t1LoopStart.value<1) t1LoopStart.value=1;
  if(+t1LoopEnd.value<1) t1LoopEnd.value=Math.min(max,+t1LoopEnd.value||1);
}

// ----------------------
// Validation
function validateAll(){
  fpsLabel.textContent=fps.value;
  if(!frames.length){ generateBtn.disabled=true; setStatus('Upload PNG frames first','error'); return false; }
  if(activeTool===1){
    const max=frames.length, lS=+t1LoopStart.value,lE=+t1LoopEnd.value;
    if(!(lS>=1 && lE>=lS && lE<=max)){ generateBtn.disabled=true; setStatus('Tool 1: final loop invalid','error'); return false; }
    if(!validateList(intros1Container)){ generateBtn.disabled=true; return false; }
    generateBtn.disabled=false; setStatus('Ready: Tool 1 configuration valid','info'); return true;
  }else{
    const count=intros2Container.querySelectorAll('.intro-panel').length;
    if(count===0){ generateBtn.disabled=true; setStatus('Tool 2: add at least one section','error'); return false; }
    if(!validateList(intros2Container)){ generateBtn.disabled=true; return false; }
    generateBtn.disabled=false; setStatus('Ready: Tool 2 configuration valid','info'); return true;
  }
}
function validateList(container){
  const panels=Array.from(container.children); let lastEnd=0;
  const max=frames.length;
  for(const p of panels){
    const s=+p.querySelector('.start').value, e=+p.querySelector('.end').value;
    if(!(s>=1 && e>=s && e<=max)){ setStatus('Invalid range','error'); return false; }
    if(s<=lastEnd){ setStatus('Sections must be ascending & non-overlapping','error'); return false; }
    lastEnd=e;
  }
  return true;
}

// ----------------------
// Generate SVG
generateBtn.addEventListener('click', async()=>{
  generateBtn.disabled=true; downloadBtn.disabled=true; copyBtn.disabled=true;
  setStatus('Building sprite sheet...','info');
  const w=frames[0].w, h=frames[0].h;
  const totalW=w*frames.length;
  const canvas=document.createElement('canvas'); canvas.width=totalW; canvas.height=h;
  const ctx=canvas.getContext('2d', {alpha:true}); ctx.imageSmoothingEnabled=false;
  for(let i=0;i<frames.length;i++){
    await drawToCanvas(ctx, frames[i].data, i*w, 0);
    if(i%20===0) setStatus(`Compositing frames ${i+1}/${frames.length}...`,'info');
  }
  const spriteData=canvas.toDataURL('image/png');
  const globalFps=+fps.value; let anims='';

  if(activeTool===1){
    let beginTime='0s';
    const panels=Array.from(intros1Container.children);
    // intros
    for(const p of panels){
      const s=+p.querySelector('.start').value-1, e=+p.querySelector('.end').value-1;
      const rep=+p.querySelector('.rep').value;
      const useCustom=p.querySelector('.useCustomFps').checked;
      const fpsVal=useCustom?+p.querySelector('.customFps').value:globalFps;
      const frameTime=1/fpsVal;
      const values=[]; for(let r=0;r<rep;r++) for(let f=s;f<=e;f++) values.push(-f*w);
      const dur=(values.length*frameTime).toFixed(3);
      const id=`anim_${Date.now()}_${Math.random()}`.replace('.','');
      anims+=`<animate id="${id}" attributeName="x" values="${values.join(';')}" dur="${dur}s" calcMode="discrete" repeatCount="1" begin="${beginTime}"/>`;
      beginTime=`${id}.end`;
    }
    // final loop
    const fS=+t1LoopStart.value-1, fE=+t1LoopEnd.value-1;
    const fFps=loopUseCustomFps.checked?+loopCustomFps.value:globalFps;
    const finalValues=[]; for(let f=fS;f<=fE;f++) finalValues.push(-f*w);
    const finalDur=((fE-fS+1)*(1/fFps)).toFixed(3);
    anims+=`<animate attributeName="x" values="${finalValues.join(';')}" dur="${finalDur}s" calcMode="discrete" repeatCount="indefinite" begin="${beginTime}"/>`;
  }else{
    // Tool 2
    const sequence=[]; let totalDur=0;
    const panels=Array.from(intros2Container.children);
    for(const p of panels){
      const s=+p.querySelector('.start').value-1, e=+p.querySelector('.end').value-1;
      const rep=+p.querySelector('.rep').value;
      const useCustom=p.querySelector('.useCustomFps').checked;
      const fpsVal=useCustom?+p.querySelector('.customFps').value:globalFps;
      const frameTime=1/fpsVal;
      for(let r=0;r<rep;r++) for(let f=s;f<=e;f++){ sequence.push({frame:f,duration:frameTime}); totalDur+=frameTime;}
    }
    if(sequence.length===0){ setStatus('No sections to play','error'); generateBtn.disabled=false; return; }
    const values=sequence.map(it=>-it.frame*w);
    const keyTimes=[]; let acc=0;
    for(let i=0;i<sequence.length;i++){ if(i>0) acc+=sequence[i-1].duration; keyTimes.push((acc/totalDur).toFixed(6)); }
    anims=`<animate attributeName="x" values="${values.join(';')}" dur="${totalDur.toFixed(3)}s" keyTimes="${keyTimes.join(';')}" calcMode="discrete" repeatCount="indefinite" begin="0s"/>`;
  }

  svgContent=buildSvg(spriteData,w,h,totalW,anims);
  const blob=new Blob([svgContent],{type:'image/svg+xml'});
  const url=URL.createObjectURL(blob);
  preview.innerHTML=`<object type="image/svg+xml" data="${url}" style="width:100%;height:100%;image-rendering:pixelated;"></object>`;
  downloadBtn.disabled=false; copyBtn.disabled=false; setStatus('SVG ready — preview shown','info'); generateBtn.disabled=false;
});

// ----------------------
// Draw helper
function drawToCanvas(ctx,dataUrl,x,y){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>{ctx.drawImage(img,x,y); res();}; img.onerror=rej; img.src=dataUrl; }); }

// ----------------------
// Build SVG
function buildSvg(spriteData,w,h,totalW,animHtml){
  return `<?xml version="1.0" encoding="utf-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="xMidYMid meet" style="image-rendering:pixelated;">
  <defs><clipPath id="clip"><rect width="${w}" height="${h}"/></clipPath></defs>
  <image href="${spriteData}" width="${totalW}" height="${h}" clip-path="url(#clip)" x="0" y="0" style="image-rendering:pixelated;">
    ${animHtml}
  </image>
</svg>`;
}

// ----------------------
// Download / Copy
downloadBtn.addEventListener('click', ()=>{
  if(!svgContent) return;
  const blob=new Blob([svgContent],{type:'image/svg+xml;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='svg-animation.svg';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  setStatus('Downloaded','info');
});

copyBtn.addEventListener('click', async()=>{
  if(!svgContent) return;
  try{ await navigator.clipboard.writeText(svgContent); setStatus('SVG copied to clipboard','info'); }catch(e){ setStatus('Copy failed','error'); }
});

// ----------------------
// Status helper
function setStatus(msg,level='info'){ statusEl.textContent=msg; }
fps.addEventListener('input', ()=> fpsLabel.textContent=fps.value);

// ----------------------
// Init
setActiveTool(1);
</script>
</body>
</html>
